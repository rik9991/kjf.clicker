<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>KJF Clicker - TON Mini App</title>

    <!-- CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- TON Connect UI React SDK (UMD) -->
    <script src="https://unpkg.com/@tonconnect/ui-react@latest/dist/ton-connect-ui-react.umd.js"></script>

    <style>
        @import url("https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap");
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            margin: 0;
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="text-center text-gray-500 p-8">Caricamento dell'applicazione in corso...</div>
    </div>

    <!-- CODICE REACT: usare type="text/babel" evita problemi di escaping/interpolazione -->
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        // TonConnectUiReact è esposto dal file UMD; attenzione al nome esatto
        const {
            TonConnectUIProvider,
            TonConnectButton,
            useTonAddress,
            useTonConnectUI,
            useTonWallet
        } = window.TonConnectUiReact || {};

        // --- Variabili Globali (per il Token KJF) ---
        const INITIAL_TOKEN_BALANCE = 1000000;
        const INITIAL_CLICK_VALUE = 1;
        const KJF_SYMBOL = "KJF";

        const formatNumber = (num) => {
            if (num >= 1000000000) return (num / 1000000000).toFixed(1) + 'B';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num;
        };

        const TapFeedback = ({ id, x, y, value }) => {
            const [isVisible, setIsVisible] = useState(true);

            useEffect(() => {
                const timer = setTimeout(() => setIsVisible(false), 800);
                return () => clearTimeout(timer);
            }, []);

            if (!isVisible) return null;

            const style = {
                position: 'absolute',
                left: x,
                top: y,
                pointerEvents: 'none',
                transition: 'transform 0.8s ease-out, opacity 0.8s ease-out',
                transform: 'translate(-50%, 0)',
                opacity: 1,
                animation: 'tap-up 0.8s ease-out forwards',
            };

            return (
                <div style={style} className="text-2xl font-bold text-green-400 select-none">
                    +{value}
                </div>
            );
        };

        const App = () => {
            const [balance, setBalance] = useState(INITIAL_TOKEN_BALANCE);
            const [clickValue, setClickValue] = useState(INITIAL_CLICK_VALUE);
            const [feedback, setFeedback] = useState([]);
            const [isConnected, setIsConnected] = useState(false);

            // Hook TonConnect (se il bundle è caricato)
            const rawAddress = useTonAddress ? useTonAddress() : null;
            const wallet = useTonWallet ? useTonWallet() : null;
            const tonConnectUI = useTonConnectUI ? useTonConnectUI() : null;
            const connectUI = tonConnectUI ? tonConnectUI.connectUI : null;

            // Controlla se siamo nell'ambiente Telegram WebApp (TWA)
            const isTWA = window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData;

            useEffect(() => {
                setIsConnected(!!wallet);

                if (isTWA && window.Telegram && window.Telegram.WebApp && typeof window.Telegram.WebApp.ready === 'function') {
                    window.Telegram.WebApp.ready();
                    if (typeof window.Telegram.WebApp.expand === 'function') {
                        window.Telegram.WebApp.expand();
                    }
                }
            }, [wallet, isTWA]);

            const userFriendlyAddress = useMemo(() => {
                if (rawAddress) {
                    return rawAddress.slice(0, 4) + '...' + rawAddress.slice(-4);
                }
                return 'Non Connesso';
            }, [rawAddress]);

            const handleTap = (e) => {
                // Se TonConnect non è disponibile, apriamo il modal se possibile
                if (!isConnected) {
                    if (connectUI && typeof connectUI.openModal === 'function') {
                        connectUI.openModal();
                    } else {
                        // fallback: messaggio in console
                        console.warn('Wallet non connesso e TonConnect UI non disponibile.');
                    }
                    return;
                }

                setBalance(b => b + clickValue);

                const clientX = (e.changedTouches && e.changedTouches[0] && e.changedTouches[0].clientX) || e.clientX || window.innerWidth / 2;
                const clientY = (e.changedTouches && e.changedTouches[0] && e.changedTouches[0].clientY) || e.clientY || window.innerHeight / 2;

                const newFeedback = {
                    id: Date.now(),
                    x: clientX,
                    y: clientY,
                    value: clickValue,
                };

                setFeedback(f => [...f, newFeedback]);

                setTimeout(() => {
                    setFeedback(f => f.filter(item => item.id !== newFeedback.id));
                }, 800);
            };

            const tapAreaClasses = isConnected
                ? 'bg-yellow-400 hover:bg-yellow-500 active:scale-95 cursor-pointer'
                : 'bg-gray-300 cursor-not-allowed';

            return (
                <div className="flex flex-col items-center justify-between w-full max-w-sm h-full max-h-[800px] p-4 bg-white shadow-2xl rounded-2xl border border-gray-100 relative overflow-hidden" style={{ minHeight: '600px' }}>
                    <style>{`
                        @keyframes tap-up {
                            0% { transform: translate(-50%, 0); opacity: 1; }
                            100% { transform: translate(-50%, -100px); opacity: 0; }
                        }
                    `}</style>

                    {feedback.map(f => (
                        <TapFeedback key={f.id} id={f.id} x={f.x} y={f.y} value={f.value} />
                    ))}

                    <div className="w-full mb-6">
                        <div className="text-center">
                            <h1 className="text-3xl font-extrabold text-gray-800">KJF Clicker</h1>
                            <p className="text-sm text-gray-500 mt-1">TON Mini App</p>
                        </div>

                        <div className={`mt-4 p-3 rounded-xl flex items-center justify-between transition-colors ${isConnected ? 'bg-green-50' : 'bg-red-50'}`}>
                            <span className={`text-xs font-medium ${isConnected ? 'text-green-600' : 'text-red-600'}`}>
                                Stato: {isConnected ? 'Wallet Connesso' : 'Disconnesso'}
                            </span>
                            <span className="text-xs text-gray-500 font-mono">
                                ID Utente: {userFriendlyAddress}
                            </span>
                        </div>
                    </div>

                    <div className="flex flex-col items-center flex-grow justify-center">
                        <p className="text-lg text-gray-600">Il tuo Saldo KJF</p>
                        <h2 className="text-6xl font-black text-gray-800 tracking-tighter mt-1 mb-6">
                            {formatNumber(balance)}
                            <span className="text-2xl ml-2 text-yellow-500">{KJF_SYMBOL}</span>
                        </h2>

                        <div
                            className={`relative w-48 h-48 rounded-full shadow-2xl transition-all duration-100 ease-out flex items-center justify-center ${tapAreaClasses}`}
                            onClick={handleTap}
                            onTouchStart={handleTap}
                        >
                            <span className="text-5xl font-bold text-white shadow-sm pointer-events-none">
                                +{clickValue}
                            </span>
                            <img src="https://placehold.co/80x80/222222/ffffff?text=KJF" alt="KJF Icon" className="w-20 h-20 absolute" />
                        </div>

                        <p className="mt-4 text-sm text-gray-500">
                            Clicca sull'area per minare!
                        </p>
                    </div>

                    <div className="w-full mt-6">
                        <TonConnectButton className="ton-connect-button" />
                    </div>
                </div>
            );
        };

        // Manifest URL (assicurati che sia corretto)
        const manifestUrl = 'https://rik9991.github.io/kjf.clicker/tonconnect-manifest.json';

        // Azione: se TonConnect UI Provider non è caricato informeremo in console, ma proviamo comunque a renderizzare (per evitare crash)
        if (!TonConnectUIProvider) {
            console.warn('TonConnectUIProvider non trovato. Verifica che il bundle @tonconnect/ui-react sia correttamente caricato.');
        }

        ReactDOM.render(
            <TonConnectUIProvider
                manifestUrl={manifestUrl}
                actionsConfiguration={{ twaReturnUrl: (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData) ? window.Telegram.WebApp.initData : '' }}
            >
                <App />
            </TonConnectUIProvider>,
            document.getElementById('root')
        );
    </script>

    <!-- Opzionale: diagnostica console se qualcosa non è presente -->
    <script>
        window.addEventListener('load', () => {
            console.log('Diagnostica caricamento librerie:');
            console.log(' React:', typeof React !== 'undefined');
            console.log(' ReactDOM:', typeof ReactDOM !== 'undefined');
            console.log(' Babel:', typeof Babel !== 'undefined');
            console.log(' TonConnectUiReact:', typeof window.TonConnectUiReact !== 'undefined');
        });
    </script>
</body>
</html>

