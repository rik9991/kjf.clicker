<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KJF Clicker - TON Mini App</title>
    
    <!-- Caricamento delle dipendenze essenziali (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Caricamento TON Connect UI React SDK -->
    <script src="https://unpkg.com/@tonconnect/ui-react@latest/dist/ton-connect-ui-react.umd.js"></script>

    <style>
        /* Imposta il font Inter e il box-sizing */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            margin: 0;
        }
    </style>
</head>
<body>
    <!-- Il container principale di React -->
    <div id="root"></div>

    <!-- CODICE REACT/JSX: ESEGUITO DA BABEL -->
    <script type="text/babel">
        // Estraggo i componenti globali resi disponibili dal CDN
        const { useState, useEffect, useCallback, useMemo } = React;
        const { TonConnectUIProvider, TonConnectButton, useTonAddress, useTonConnectUI, useTonWallet } = TonConnectUiReact;

        // --- Variabili Globali (per il Token KJF) ---
        const INITIAL_TOKEN_BALANCE = 1000000;
        const INITIAL_CLICK_VALUE = 1;
        const KJF_SYMBOL = "KJF";

        // Funzione per formattare i numeri (es. 1000000 -> 1M)
        const formatNumber = (num) => {
            if (num >= 1000000000) return (num / 1000000000).toFixed(1) + 'B';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num;
        };

        // --- Componente per l'Animazione del Tap ---
        const TapFeedback = ({ id, x, y, value }) => {
            const [isVisible, setIsVisible] = useState(true);

            useEffect(() => {
                const timer = setTimeout(() => {
                    setIsVisible(false);
                }, 800); 
                return () => clearTimeout(timer);
            }, []);

            if (!isVisible) return null;

            // Stile per far salire il numero e svanire
            const style = {
                position: 'absolute',
                left: x,
                top: y,
                pointerEvents: 'none',
                transition: 'transform 0.8s ease-out, opacity 0.8s ease-out',
                transform: 'translate(-50%, 0)', // Centro X
                opacity: 1,
                // Applica l'animazione di salita
                animation: 'tap-up 0.8s ease-out forwards',
            };
            
            return (
                <div style={style} className="text-2xl font-bold text-green-400 select-none">
                    +{value}
                </div>
            );
        };

        // --- Componente Principale del Clicker ---
        const App = () => {
            const [balance, setBalance] = useState(INITIAL_TOKEN_BALANCE);
            const [clickValue, setClickValue] = useState(INITIAL_CLICK_VALUE);
            const [feedback, setFeedback] = useState([]);
            const [isConnected, setIsConnected] = useState(false);
            const rawAddress = useTonAddress(); // L'indirizzo TON non formattato
            const wallet = useTonWallet();
            const { connectUI } = useTonConnectUI();
            
            // Controlla se siamo nell'ambiente Telegram Mini App
            const isTWA = window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData;

            useEffect(() => {
                // Aggiorna lo stato di connessione quando cambia l'indirizzo o il wallet
                setIsConnected(!!wallet);
                
                // Inizializzazione per l'ambiente Telegram
                if (isTWA) {
                    window.Telegram.WebApp.ready();
                    window.Telegram.WebApp.expand();
                }
            }, [wallet, isTWA]);

            // Formatta l'indirizzo per la visualizzazione
            const userFriendlyAddress = useMemo(() => {
                if (rawAddress) {
                    return rawAddress.slice(0, 4) + '...' + rawAddress.slice(-4);
                }
                return 'Non Connesso';
            }, [rawAddress]);

            // Funzione eseguita al click
            const handleTap = (e) => {
                if (!isConnected) {
                    // Se non connesso, apriamo la modale di connessione
                    connectUI.openModal();
                    return; 
                }
                
                // Aggiorna il saldo
                setBalance(b => b + clickValue);

                // Aggiunge feedback visivo
                const newFeedback = {
                    id: Date.now(),
                    // Usiamo e.changedTouches[0] se l'evento è touch, altrimenti e
                    x: e.changedTouches ? e.changedTouches[0].clientX : e.clientX,
                    y: e.changedTouches ? e.changedTouches[0].clientY : e.clientY,
                    value: clickValue,
                };
                setFeedback(f => [...f, newFeedback]);

                // Rimuove il feedback dopo un breve ritardo per mantenere la pulizia
                setTimeout(() => {
                    setFeedback(f => f.filter(item => item.id !== newFeedback.id));
                }, 800);
            };
            
            // Classe condizionale Tailwind per lo sfondo del pulsante
            const tapAreaClasses = isConnected 
                ? 'bg-yellow-400 hover:bg-yellow-500 active:scale-95 cursor-pointer' 
                : 'bg-gray-300 cursor-not-allowed';

            return (
                <div className="flex flex-col items-center justify-between w-full max-w-sm h-full max-h-[800px] p-4 bg-white shadow-2xl rounded-2xl border border-gray-100 relative overflow-hidden" style={{ minHeight: '600px' }}>
                    
                    {/* Animazione CSS per il feedback del tap */}
                    <style>{`
                        @keyframes tap-up {
                            0% { transform: translate(-50%, 0); opacity: 1; }
                            100% { transform: translate(-50%, -100px); opacity: 0; }
                        }
                    `}</style>

                    {/* Feedback dei click */}
                    {feedback.map(f => (
                        <TapFeedback key={f.id} id={f.id} x={f.x} y={f.y} value={f.value} />
                    ))}
                    
                    {/* Intestazione e Stato Connessione */}
                    <div className="w-full mb-6">
                        <div className="text-center">
                            <h1 className="text-3xl font-extrabold text-gray-800">KJF Clicker</h1>
                            <p className="text-sm text-gray-500 mt-1">TON Mini App</p>
                        </div>

                        {/* Stato Connessione */}
                        <div className={`mt-4 p-3 rounded-xl flex items-center justify-between transition-colors ${isConnected ? 'bg-green-50' : 'bg-red-50'}`}>
                            <span className={`text-xs font-medium ${isConnected ? 'text-green-600' : 'text-red-600'}`}>
                                Stato: {isConnected ? 'Wallet Connesso' : 'Disconnesso'}
                            </span>
                            <span className="text-xs text-gray-500 font-mono">
                                ID Utente: {userFriendlyAddress}
                            </span>
                        </div>
                    </div>

                    {/* Area Bilancio */}
                    <div className="flex flex-col items-center flex-grow justify-center">
                        <p className="text-lg text-gray-600">Il tuo Saldo KJF</p>
                        <h2 className="text-6xl font-black text-gray-800 tracking-tighter mt-1 mb-6">
                            {formatNumber(balance)}
                            <span className="text-2xl ml-2 text-yellow-500">{KJF_SYMBOL}</span>
                        </h2>

                        {/* Immagine Clicker/Area di Tap (Aggiunto supporto touch/click) */}
                        <div 
                            className={`relative w-48 h-48 rounded-full shadow-2xl transition-all duration-100 ease-out flex items-center justify-center ${tapAreaClasses}`}
                            onClick={handleTap}
                            onTouchStart={handleTap}
                        >
                            <span className="text-5xl font-bold text-white shadow-sm pointer-events-none">
                                +{clickValue}
                            </span>
                            {/* Icona Kim Jong Fun (Placeholder) */}
                            <img src="https://placehold.co/80x80/222222/ffffff?text=KJF" alt="KJF Icon" className="w-20 h-20 absolute" />
                        </div>

                        <p className="mt-4 text-sm text-gray-500">
                            Clicca sull'area per minare!
                        </p>
                    </div>

                    {/* Pulsante TON Connect */}
                    <div className="w-full mt-6">
                        <TonConnectButton className="ton-connect-button" />
                    </div>
                </div>
            );
        };
        
        // --- RENDERING DELL'APP ---

        // L'URL del manifest è NECESSARIO per TonConnectUIProvider
        const manifestUrl = 'https://rik9991.github.io/kjf.clicker/tonconnect-manifest.json';

        // Renderizza l'app, avvolgendola in TonConnectUIProvider
        ReactDOM.render(
            <TonConnectUIProvider 
                manifestUrl={manifestUrl}
                // Configurazione per l'ambiente Telegram Mini App
                actionsConfiguration={{ twaReturnUrl: window.Telegram ? window.Telegram.WebApp.initData : '' }}
            >
                <App />
            </TonConnectUIProvider>,
            document.getElementById('root')
        );
    </script>
</body>
</html>
